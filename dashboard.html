<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barrier Control</title>
<style>
  :root {
    --bg: #0a0e17; --card: #111827; --card-hover: #151f30; --border: #1e293b;
    --text: #e2e8f0; --dim: #64748b; --muted: #475569;
    --green: #22c55e; --red: #ef4444; --amber: #eab308; --blue: #3b82f6;
    --orange: #f97316; --purple: #8b5cf6; --cyan: #06b6d4;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif; font-size: 14px; }
  .container { max-width: 1400px; margin: 0 auto; padding: 16px; }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
  .header h1 { font-size: 1.3rem; display: flex; align-items: center; gap: 8px; }
  .header h1 span { font-size: 0.65rem; color: var(--dim); font-weight: 400; }
  .ws-badge { display: inline-flex; align-items: center; gap: 5px; font-size: 0.7rem; padding: 3px 10px; border-radius: 12px; }
  .ws-badge.connected { background: rgba(34,197,94,0.12); color: var(--green); }
  .ws-badge.disconnected { background: rgba(239,68,68,0.12); color: var(--red); }
  .clock { font-family: 'SF Mono', Menlo, monospace; font-size: 0.8rem; color: var(--dim); }

  /* Cards */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; transition: border-color 0.3s; }

  /* Emergency bar */
  .emergency { display: flex; gap: 8px; margin-bottom: 16px; padding: 12px 16px; background: linear-gradient(135deg, #111827, #1a1025); border: 1px solid var(--border); border-radius: 10px; align-items: center; flex-wrap: wrap; }
  .emergency .label { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; margin-right: auto; }
  .btn { border: none; border-radius: 8px; padding: 8px 14px; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 5px; }
  .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn:active { transform: scale(0.97) translateY(0); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; filter: none; transform: none; }
  .btn-lift { background: rgba(34,197,94,0.12); color: var(--green); border: 1px solid rgba(34,197,94,0.25); }
  .btn-close { background: rgba(239,68,68,0.12); color: var(--red); border: 1px solid rgba(239,68,68,0.25); }
  .btn-stop { background: rgba(249,115,22,0.12); color: var(--orange); border: 1px solid rgba(249,115,22,0.25); }
  .btn-lock { background: rgba(139,92,246,0.12); color: var(--purple); border: 1px solid rgba(139,92,246,0.25); }
  .btn-em { padding: 10px 18px; font-size: 0.8rem; letter-spacing: 0.02em; }
  .btn-em-lift { background: rgba(34,197,94,0.15); color: var(--green); border: 2px solid rgba(34,197,94,0.5); }
  .btn-em-close { background: rgba(239,68,68,0.15); color: var(--red); border: 2px solid rgba(239,68,68,0.5); }
  .btn-em-kill { background: rgba(239,68,68,0.25); color: #fca5a5; border: 2px solid rgba(239,68,68,0.6); }

  /* Services */
  .services { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px; }
  .svc { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; transition: border-color 0.3s; }
  .svc.online { border-color: rgba(34,197,94,0.2); }
  .svc.offline { border-color: rgba(239,68,68,0.2); }
  .svc .name { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 4px; }
  .svc .val { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }
  .svc .lat { font-size: 0.6rem; color: var(--muted); margin-top: 2px; }

  /* Indicator dot */
  .ind { width: 7px; height: 7px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
  .ind.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .ind.off { background: #334155; }
  .ind.err { background: var(--red); box-shadow: 0 0 6px var(--red); }

  /* Mimic boards */
  .mimic-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .mimic h3 { font-size: 0.8rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .mimic h3 .lat { font-size: 0.6rem; color: var(--muted); font-weight: 400; margin-left: auto; }
  .ch-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
  .ch { text-align: center; padding: 10px 4px 8px; border-radius: 8px; border: 1px solid var(--border); transition: all 0.3s; cursor: default; }
  .ch.active { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.35); box-shadow: 0 0 10px rgba(34,197,94,0.15); }
  .ch .num { font-size: 0.6rem; color: var(--muted); margin-bottom: 4px; }
  .ch .led { width: 14px; height: 14px; border-radius: 50%; margin: 0 auto 4px; transition: all 0.3s; }
  .ch.active .led { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .ch:not(.active) .led { background: #1e293b; border: 1px solid #334155; }
  .ch .lbl { font-size: 0.5rem; color: var(--dim); line-height: 1.15; min-height: 20px; }
  .ch.active .lbl { color: var(--green); font-weight: 600; }

  /* Barrier grid */
  .barrier-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-bottom: 16px; }
  .barrier-card { transition: border-color 0.3s, box-shadow 0.3s; }
  .barrier-card.latched-open { border-color: rgba(34,197,94,0.3); box-shadow: 0 0 15px rgba(34,197,94,0.08); }
  .barrier-card.latched-closed { border-color: rgba(239,68,68,0.3); box-shadow: 0 0 15px rgba(239,68,68,0.08); }
  .barrier-card.error { border-color: rgba(239,68,68,0.3); }
  .b-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .b-name { font-size: 0.9rem; font-weight: 600; }
  .b-sub { font-size: 0.65rem; color: var(--dim); }
  .b-status { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 600; }
  .badge-locked { background: rgba(139,92,246,0.15); color: var(--purple); }
  .badge-latch { animation: pulse 2s infinite; }
  .badge-latch-open { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-latch-closed { background: rgba(239,68,68,0.15); color: var(--red); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

  .b-coils { display: flex; gap: 16px; padding: 8px 12px; background: rgba(15,23,42,0.5); border-radius: 6px; margin-bottom: 10px; }
  .b-coil { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .b-coil .ind { width: 8px; height: 8px; }

  .b-info { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; font-size: 0.75rem; }
  .b-info .kv { display: flex; justify-content: space-between; padding: 3px 0; }
  .b-info .k { color: var(--dim); }
  .b-info .v { font-weight: 600; font-family: 'SF Mono', Menlo, monospace; font-size: 0.7rem; }

  .b-controls { display: flex; gap: 6px; flex-wrap: wrap; }
  .b-controls .btn { flex: 1; min-width: 0; justify-content: center; }
  .b-latch { display: flex; gap: 6px; margin-top: 6px; }
  .b-latch .btn { flex: 1; justify-content: center; }

  /* Heartbeat bar */
  .hb { display: flex; gap: 1.5px; align-items: center; margin-top: 10px; }
  .hb-t { width: 4px; height: 14px; border-radius: 1px; transition: background 0.3s; }

  /* Log */
  .log-section { margin-bottom: 20px; }
  .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
  .log-header h2 { font-size: 0.95rem; }
  .log-filters { display: flex; gap: 6px; flex-wrap: wrap; }
  .log-filters select, .log-filters input {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    padding: 5px 8px; border-radius: 6px; font-size: 0.72rem;
  }
  .log-wrap { max-height: 400px; overflow-y: auto; }
  .log-table { width: 100%; border-collapse: collapse; }
  .log-table th { text-align: left; padding: 6px 10px; font-size: 0.6rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.07em; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--card); }
  .log-table td { padding: 5px 10px; font-size: 0.75rem; border-bottom: 1px solid #131b2a; transition: background 0.3s; }
  .log-table tr:hover td { background: rgba(255,255,255,0.02); }
  .log-table tr.new td { animation: flash 1s; }
  @keyframes flash { 0% { background: rgba(59,130,246,0.15); } 100% { background: transparent; } }
  .tag { display: inline-block; padding: 1px 7px; border-radius: 4px; font-size: 0.6rem; font-weight: 600; letter-spacing: 0.02em; }
  .tag-lift, .tag-latch-open, .tag-latch { background: rgba(34,197,94,0.12); color: var(--green); }
  .tag-close, .tag-latch-close { background: rgba(239,68,68,0.12); color: var(--red); }
  .tag-stop { background: rgba(249,115,22,0.12); color: var(--orange); }
  .tag-lock, .tag-unlock, .tag-unlatch { background: rgba(139,92,246,0.12); color: var(--purple); }
  .tag-emergency-off, .tag-emergency-lift, .tag-emergency-close { background: rgba(220,38,38,0.2); color: #fca5a5; }
  .tag-error { background: rgba(239,68,68,0.12); color: var(--red); }
  .tag-heartbeat { background: rgba(59,130,246,0.1); color: var(--blue); }
  .tag-startup, .tag-pulse-off { background: rgba(100,116,139,0.12); color: var(--dim); }
  .mono { font-family: 'SF Mono', Menlo, monospace; }

  /* Toast */
  .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 18px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; z-index: 100; opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: translateY(10px); pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.ok { background: rgba(34,197,94,0.95); color: #fff; }
  .toast.fail { background: rgba(239,68,68,0.95); color: #fff; }

  /* Responsive */
  @media (max-width: 900px) {
    .mimic-row { grid-template-columns: 1fr; }
    .barrier-grid { grid-template-columns: 1fr; }
    .emergency { flex-direction: column; align-items: stretch; }
    .emergency .label { margin-bottom: 6px; }
  }
  @media (max-width: 600px) {
    .container { padding: 10px; }
    .header h1 { font-size: 1.1rem; }
    .ch-grid { grid-template-columns: repeat(4, 1fr); }
    .services { grid-template-columns: repeat(2, 1fr); }
    .b-controls .btn { font-size: 0.7rem; padding: 7px 8px; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <h1>üöß Barrier Control <span>Kyle Rise Surface</span></h1>
    <div style="display:flex;align-items:center;gap:12px">
      <span id="ws-badge" class="ws-badge disconnected"><span class="ind off"></span> Connecting...</span>
      <span class="clock" id="clock"></span>
    </div>
  </div>

  <!-- Emergency -->
  <div class="emergency">
    <span class="label">‚ö° Emergency Controls</span>
    <button class="btn btn-em btn-em-lift" onclick="emergencyLift()">‚ñ≤ LIFT ALL</button>
    <button class="btn btn-em btn-em-close" onclick="emergencyClose()">‚ñº CLOSE ALL</button>
    <button class="btn btn-em btn-em-kill" onclick="emergencyOff()">‚ö° KILL ALL COILS</button>
  </div>

  <!-- Services -->
  <div class="services" id="services"></div>

  <!-- Mimic Boards -->
  <div class="mimic-row">
    <div class="card mimic" id="mimic-64">
      <h3>üìü Relay .64 <span class="lat" id="mimic-64-lat"></span></h3>
      <div class="ch-grid" id="mimic-64-grid"></div>
    </div>
    <div class="card mimic" id="mimic-65">
      <h3>üìü Relay .65 <span class="lat" id="mimic-65-lat"></span></h3>
      <div class="ch-grid" id="mimic-65-grid"></div>
    </div>
  </div>

  <!-- Barriers -->
  <div class="barrier-grid" id="barriers"></div>

  <!-- Log -->
  <div class="card log-section">
    <div class="log-header">
      <h2>üìã Activity Log</h2>
      <div class="log-filters">
        <select id="f-barrier"><option value="">All barriers</option></select>
        <select id="f-type">
          <option value="">All types</option>
          <option value="lift">Lift</option><option value="close">Close</option><option value="stop">Stop</option>
          <option value="latch-open">Latch Open</option><option value="latch-close">Latch Close</option><option value="unlatch">Unlatch</option>
          <option value="lock">Lock</option><option value="unlock">Unlock</option>
          <option value="emergency-off">Emergency Off</option><option value="emergency-lift">Emergency Lift</option>
          <option value="error">Error</option>
        </select>
        <input type="text" id="f-search" placeholder="Search...">
      </div>
    </div>
    <div class="log-wrap">
      <table class="log-table"><thead><tr><th>Time</th><th>Type</th><th>Barrier</th><th>Details</th></tr></thead>
      <tbody id="log-body"></tbody></table>
    </div>
  </div>

</div>
<div id="toast" class="toast"></div>

<script>
const COIL_MAP = {
  '64': { 0:'Entry\nLIFT', 1:'Entry\nSTOP', 2:'Entry\nCLOSE', 3:'Exit\nLIFT', 4:'Exit\nCLOSE', 5:'Exit\nSTOP', 6:'', 7:'' },
  '65': { 0:'', 1:'', 2:'', 3:'Combo\nCLOSE', 4:'Combo\nLIFT', 5:'Combo\nSTOP', 6:'', 7:'' }
};

let ws = null;
let logEntries = [];
let heartbeatHistory = {};
let state = { barriers: [], relays: {} };

const $ = id => document.getElementById(id);

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ
function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    $('ws-badge').className = 'ws-badge connected';
    $('ws-badge').innerHTML = '<span class="ind on"></span> Live';
  };
  ws.onclose = () => {
    $('ws-badge').className = 'ws-badge disconnected';
    $('ws-badge').innerHTML = '<span class="ind err"></span> Reconnecting...';
    setTimeout(connect, 2000);
  };
  ws.onerror = () => ws.close();
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'state') {
        state = msg;
        renderMimic();
        renderBarriers();
      } else if (msg.type === 'log') {
        logEntries.unshift(msg.entry);
        if (logEntries.length > 500) logEntries.pop();
        renderLog(true);
      }
    } catch {}
  };
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg, ok) {
  const t = $('toast');
  t.textContent = msg;
  t.className = `toast ${ok ? 'ok' : 'fail'} show`;
  clearTimeout(t._to);
  t._to = setTimeout(() => t.className = 'toast', 2500);
}

// ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ
async function api(path, method = 'POST') {
  try {
    const r = await fetch(path, { method });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || `HTTP ${r.status}`);
    return d;
  } catch (e) { toast(e.message, false); throw e; }
}

async function barrierAction(id, action) {
  await api(`/api/barrier/${id}/${action}`);
  toast(`${action.toUpperCase()} ‚Üí ${id}`, true);
}
async function latchOpen(id) { await api(`/api/barrier/${id}/latch-open`); toast(`LATCHED OPEN ‚Üí ${id}`, true); }
async function latchClose(id) { await api(`/api/barrier/${id}/latch-close`); toast(`LATCHED CLOSED ‚Üí ${id}`, true); }
async function unlatch(id) { await api(`/api/barrier/${id}/unlatch`); toast(`UNLATCHED ‚Üí ${id}`, true); }
async function toggleLock(id, locked) { await barrierAction(id, locked ? 'unlock' : 'lock'); }

async function emergencyLift() {
  if (!confirm('‚ö†Ô∏è EMERGENCY LIFT ALL: Hold all barriers open?')) return;
  for (const b of state.barriers) { try { await api(`/api/barrier/${b.id}/latch-open`); } catch {} }
  toast('ALL BARRIERS LATCHED OPEN', true);
}
async function emergencyClose() {
  if (!confirm('‚ö†Ô∏è EMERGENCY CLOSE ALL: Close and latch all barriers?')) return;
  for (const b of state.barriers) { try { await api(`/api/barrier/${b.id}/latch-close`); } catch {} }
  toast('ALL BARRIERS LATCHED CLOSED', true);
}
async function emergencyOff() {
  if (!confirm('‚ö° KILL ALL COILS: Cut power to all relay boards?')) return;
  await api('/api/emergency-off');
  toast('ALL COILS KILLED', true);
}

// ‚îÄ‚îÄ Services ‚îÄ‚îÄ
async function fetchServices() {
  const checks = await Promise.all([
    checkSvc('Barrier API', '/api/health'),
    checkSvc('SentryFlow', '/api/svc/sentryflow'),
    checkSvc('Relay .64', '/api/svc/relay/10.10.10.64'),
    checkSvc('Relay .65', '/api/svc/relay/10.10.10.65'),
  ]);
  $('services').innerHTML = checks.map(s => `
    <div class="svc ${s.ok ? 'online' : 'offline'}">
      <div class="name">${s.name}</div>
      <div class="val" style="color:${s.ok ? 'var(--green)' : 'var(--red)'}">
        <span class="ind ${s.ok ? 'on' : 'err'}"></span> ${s.ok ? 'Online' : 'Offline'}
      </div>
      ${s.ms !== null ? `<div class="lat">${s.ms}ms</div>` : ''}
    </div>
  `).join('');
}
async function checkSvc(name, url) {
  const t0 = performance.now();
  try {
    const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
    return { name, ok: r.ok, ms: Math.round(performance.now() - t0) };
  } catch { return { name, ok: false, ms: null }; }
}

// ‚îÄ‚îÄ Mimic Boards ‚îÄ‚îÄ
function renderMimic() {
  for (const board of ['64', '65']) {
    const host = `10.10.10.${board}`;
    const grid = $(`mimic-${board}-grid`);
    const coils = state.relays?.[host];
    const map = COIL_MAP[board];

    if (typeof coils === 'string') {
      grid.innerHTML = `<div style="grid-column:span 8;color:var(--red);font-size:0.72rem;padding:8px">‚ö† ${coils}</div>`;
      $(`mimic-${board}-lat`).textContent = '';
      continue;
    }
    if (!Array.isArray(coils)) continue;

    $(`mimic-${board}-lat`).textContent = '';
    grid.innerHTML = coils.slice(0, 8).map((on, i) => `
      <div class="ch ${on ? 'active' : ''}">
        <div class="num">CH${i}</div>
        <div class="led"></div>
        <div class="lbl">${(map[i] || '‚Äî').replace('\n', '<br>')}</div>
      </div>
    `).join('');
  }
}

// ‚îÄ‚îÄ Barriers ‚îÄ‚îÄ
function renderBarriers() {
  const dir = { entry: '‚¨áÔ∏è', exit: '‚¨ÜÔ∏è', both: '‚ÜïÔ∏è' };
  $('barriers').innerHTML = (state.barriers || []).map(b => {
    const hasErr = !!b.error;
    const c = b.coils || {};
    const isLatchOpen = b.locked && c.lift;
    const isLatchClosed = b.locked && c.close;
    const cls = isLatchOpen ? 'latched-open' : isLatchClosed ? 'latched-closed' : hasErr ? 'error' : '';

    if (!heartbeatHistory[b.id]) heartbeatHistory[b.id] = [];
    heartbeatHistory[b.id].push(!hasErr);
    if (heartbeatHistory[b.id].length > 40) heartbeatHistory[b.id].shift();

    return `<div class="card barrier-card ${cls}">
      <div class="b-header">
        <div>
          <div class="b-name">${dir[b.direction] || ''} ${b.name}</div>
          <div class="b-sub">${b.id} ¬∑ ${b.site || ''}</div>
        </div>
        <div class="b-status">
          ${isLatchOpen ? '<span class="badge badge-latch badge-latch-open">‚ñ≤ LATCHED OPEN</span>' : ''}
          ${isLatchClosed ? '<span class="badge badge-latch badge-latch-closed">‚ñº LATCHED CLOSED</span>' : ''}
          ${b.locked && !isLatchOpen && !isLatchClosed ? '<span class="badge badge-locked">üîí LOCKED</span>' : ''}
        </div>
      </div>
      ${hasErr ? `<div style="color:var(--red);font-size:0.8rem;padding:8px 0">‚ö† ${b.error}</div>` : `
        <div class="b-coils">
          <div class="b-coil"><span class="ind ${c.lift ? 'on' : 'off'}"></span> Lift</div>
          <div class="b-coil"><span class="ind ${c.stop ? 'on' : 'off'}"></span> Stop</div>
          <div class="b-coil"><span class="ind ${c.close ? 'on' : 'off'}"></span> Close</div>
        </div>
        <div class="b-info">
          <div class="kv"><span class="k">Last</span><span class="v">${b.lastAction || '‚Äî'}</span></div>
          <div class="kv"><span class="k">Time</span><span class="v">${b.lastActionTime ? new Date(b.lastActionTime).toLocaleTimeString('en-GB') : '‚Äî'}</span></div>
        </div>
      `}
      <div class="b-controls">
        <button class="btn btn-lift" onclick="barrierAction('${b.id}','lift')" ${b.locked?'disabled':''}>‚ñ≤ Lift</button>
        <button class="btn btn-stop" onclick="barrierAction('${b.id}','stop')">‚è∏ Stop</button>
        <button class="btn btn-close" onclick="barrierAction('${b.id}','close')" ${b.locked?'disabled':''}>‚ñº Close</button>
      </div>
      <div class="b-latch">
        ${b.locked
          ? `<button class="btn btn-lock" onclick="unlatch('${b.id}')">üîì Unlatch</button>`
          : `<button class="btn btn-lift" onclick="latchOpen('${b.id}')">‚ñ≤ Latch Open</button>
             <button class="btn btn-close" onclick="latchClose('${b.id}')">‚ñº Latch Closed</button>
             <button class="btn btn-lock" onclick="toggleLock('${b.id}',false)">üîí</button>`
        }
      </div>
      <div class="hb">${heartbeatHistory[b.id].map(ok => `<div class="hb-t" style="background:${ok ? 'var(--green)' : 'var(--red)'}"></div>`).join('')}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Log ‚îÄ‚îÄ
function renderLog(isNew) {
  const fb = $('f-barrier').value, ft = $('f-type').value, fs = $('f-search').value.toLowerCase();
  const filtered = logEntries.filter(e => {
    if (fb && e.barrier !== fb) return false;
    if (ft && e.type !== ft) return false;
    if (fs && !JSON.stringify(e).toLowerCase().includes(fs)) return false;
    return true;
  });
  $('log-body').innerHTML = filtered.slice(0, 200).map((e, i) => `
    <tr class="${isNew && i === 0 ? 'new' : ''}">
      <td class="mono" style="white-space:nowrap">${new Date(e.time).toLocaleTimeString('en-GB')}</td>
      <td><span class="tag tag-${e.type}">${e.type.toUpperCase()}</span></td>
      <td>${e.barrier || '‚Äî'}</td>
      <td style="color:var(--dim)">${e.details || ''}</td>
    </tr>
  `).join('');
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  connect();
  fetchServices();
  setInterval(fetchServices, 10000);
  // Load initial log from server
  try {
    const r = await fetch('/api/log?limit=200');
    const d = await r.json();
    logEntries = (d.entries || []);
    renderLog();
  } catch {}
  // Populate barrier filter
  try {
    const r = await fetch('/api/status');
    const d = await r.json();
    (d.barriers || []).forEach(b => {
      const o = document.createElement('option');
      o.value = b.id; o.textContent = b.name || b.id;
      $('f-barrier').appendChild(o);
    });
  } catch {}
}

$('f-barrier').onchange = () => renderLog();
$('f-type').onchange = () => renderLog();
$('f-search').oninput = () => renderLog();
setInterval(() => $('clock').textContent = new Date().toLocaleTimeString('en-GB'), 1000);
$('clock').textContent = new Date().toLocaleTimeString('en-GB');

init();
</script>
</body>
</html>
